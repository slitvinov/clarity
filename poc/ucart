#!/usr/bin/awk -f

# Create several conf.h files for udx from a template ([cart]esian
# product)

{
    F[NR] = $0
}

END {
    n = NR

    step(1, 1, 0)
}

function uncom(l) {
    # sub("//.*", "") # c++ comments
    return l
}

function emptyp(l) { return l ~ /^[ \t]*$/ }

function brp(l,   a, rc) { # [br]anch [p]redicate: is it a branch?
                           # sets VAR
    l = uncom(l)
    split(l, a)
    rc = (a[1] == "#define" && a[2] ~ /^%/)
    if (!rc) return !rc
    VAR = a[2]; sub(/^%/, "", VAR)
    return rc
}

function defp(l) {
    l = uncom(l)
    split(l, a)
    return a[1] == "#define"
}

function step(i, j, lvl) {
    if   (i > n) step0(   j, lvl)
    else         stepn(i, j, lvl)
}

function stepn(i, j, lvl,   l, nxt, m, var, val) {
    l = F[i]
    if (!brp(l)) {
	G[j] = l
	step(i + 1, j + 1, lvl)
    } else {
	var = VAR
	for (nxt = i + 1; nxt <= n && !defp(F[nxt]); nxt++) ; # find next position
	for (m = i + 1; m < nxt; m++) {
	    val = uncom(F[m])
	    if (emptyp(val)) continue
	    G[j] = "#define " var " " val
	    step(nxt, j + 1, lvl + 1)
	}
    }
}

function step0(n, lvl) { dump(G, n) }
function dump(G, n,  i) {
    for (i = 1; i <= n; i++)
	print G[i]
    print "/* end */"
}

# TEST: ucart.t0
# ./ucart test_data/t0.h   > conf.out.h
